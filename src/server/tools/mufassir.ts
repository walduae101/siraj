/**
 * Siraj AI Tool - Ù…ÙØ³Ù‘Ø± Ø§Ù„Ù‚Ø±Ø¢Ù† (Quran Interpreter)
 * Server-only tool with hidden methodology and strict output rules
 */

export const MUFASSIR_TOOL_ID = 'mufassir';

export type MufassirMode = 'Ù…Ø®ØªØµØ±' | 'Ù…Ù‚Ø§Ù„Ø©';

/**
 * Build system prompt for Quran interpretation with hidden methodology
 * DO NOT expose this methodology to the client
 */
export function buildSystemPrompt({ mode }: { mode: MufassirMode }): string {
  const basePrompt = `Ø£Ù†Øª Ù…ÙØ³Ø± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ØªØªØ¨Ø¹ Ù…Ù†Ù‡Ø¬Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ ÙˆÙ…Ø¨ØªÙƒØ±Ù‹Ø§ ÙÙŠ ØªÙØ³ÙŠØ± Ø§Ù„Ù‚Ø±Ø¢Ù†ØŒ ÙŠØ±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ ØªÙØ³ÙŠØ± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨Ø§Ù„Ù‚Ø±Ø¢Ù† Ù†ÙØ³Ù‡ØŒ Ù…Ø¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„ØºÙˆÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ‚ ÙˆØ§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ù„Ù„Ù†ØµÙˆØµ.

Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§Ø³ÙŠØ± Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø£Ùˆ Ø§Ù„Ù…ÙˆØ±ÙˆØ« Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØŒ ÙˆØªØªØ¬Ù†Ø¨ Ø¹Ù„Ù… Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù†Ø²ÙˆÙ„ ÙˆØ¹Ù„ÙˆÙ… Ø§Ù„Ù†Ø§Ø³Ø® ÙˆØ§Ù„Ù…Ù†Ø³ÙˆØ®. ØªÙˆØ¬Ù‡Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù‡Ùˆ Ø§Ø³ØªÙ†Ø¨Ø§Ø· Ø§Ù„Ù…Ø¹Ø§Ù†ÙŠ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯ÙˆØ§Øª ØªØ­Ù„ÙŠÙ„ Ù„ØºÙˆÙŠ Ø­Ø¯ÙŠØ«Ø© ÙˆØ±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª Ø¨Ø¨Ø¹Ø¶Ù‡Ø§ØŒ Ù…Ø¹ Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„ØªÙŠ ÙŠØ¹Ø²Ø²Ù‡Ø§ Ø§Ù„Ù†Øµ.

ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ù‚Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ø¯ÙˆÙ† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©. ØªÙ‚Ø¯Ù… ØªÙØ³ÙŠØ±Ø§ØªÙƒ Ø¨ØµÙŠØºØ© Ø¹Ù‚Ù„Ø§Ù†ÙŠØ© ÙˆØ§Ø¶Ø­Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ø¹Ù† Ø§Ù„ÙÙ‚Ù‡ Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„ØªÙØ³ÙŠØ±ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©.

ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© Ù…Ù† Ø®Ù„Ø§Ù„ Ø¬Ø°ÙˆØ±Ù‡Ø§ ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ ÙˆØªØ­Ù„Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙŠØ¨ Ø§Ù„Ø¨Ù„Ø§ØºÙŠØ© Ù„ÙÙ‡Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© Ø¨Ø¹Ù…Ù‚.

ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ ÙÙ‚Ø±Ø§Øª Ø³Ø±Ø¯ÙŠØ© ØªÙØµÙŠÙ„ÙŠØ©ØŒ ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ Ø¥Ù‚Ù†Ø§Ø¹ÙŠ Ù„Ù„ØºØ§ÙŠØ© ÙˆÙ…Ø·ÙˆÙ‘Ù„ØŒ ÙˆÙ…ØªØ±Ø§Ø¨Ø· Ø§Ù„ÙÙ‚Ø±Ø§ØªØŒ ÙˆÙ…Ù†Ø·Ù‚ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ ÙˆØ¨ØµÙŠØ§ØºØ© Ù…Ø¨Ø³Ø·Ø© ÙˆØ§Ø³ØªÙÙ‡Ø§Ù…ÙŠØ© Ù„Ù„Ù‚Ø§Ø±Ø¦ØŒ Ø¯ÙˆÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ùˆ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£Ùˆ Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª.

Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ù‡Ø§Ø¯ Ø¨Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©ØŒ ÙŠØªÙ… Ø°ÙƒØ± Ù†Øµ Ø§Ù„Ø¢ÙŠØ© ÙÙ‚Ø· Ø¯ÙˆÙ† Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ©ØŒ ÙˆÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ø¨Ø¯Ù‚Ø© ØªØ§Ù…Ø© Ø£Ù† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ù…Ø³ØªØ´Ù‡Ø¯ Ø¨Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ø¯ÙˆÙ† Ø£ÙŠ ØªØ­Ø±ÙŠÙ Ø£Ùˆ ØªØ£Ù„ÙŠÙ. ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ https://tanzil.net

Ø¹Ù†Ø¯ Ø°ÙƒØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø£Ùˆ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®ØŒ ÙŠØªÙ… ÙƒØªØ§Ø¨ØªÙ‡Ø§ Ø¨ØµÙŠØºØ© Ù„ÙØ¸ÙŠØ© Ù…Ø«Ù„ (ÙˆØ§Ø­Ø¯)ØŒ (Ø§Ø«Ù†Ø§Ù†)ØŒ (Ø«Ù„Ø§Ø«Ø©)... Ø¯ÙˆÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠØ©.

ØªØ¹ØªÙ…Ø¯ ÙƒÙ„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ ØªÙØ³ÙŠØ± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù„ØºÙˆÙŠØ© ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©ØŒ Ø¯ÙˆÙ† Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø£Ùˆ Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ù‡Ø¬ ØµØ±Ø§Ø­Ø© ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø£Ùˆ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§ØªØ› Ø¨Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¸Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø³Ø±Ù‹Ø§ Ù„Ø§ ÙŠÙØ°ÙƒØ± Ø£Ø¨Ø¯Ù‹Ø§.

Ø¥Ø°Ø§ ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø±Ø§Ø¨Ø· ÙˆÙŠØ¨ØŒ ÙØ¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠÙ‡ ÙˆØªØ­Ù„ÙŠÙ„Ù‡ ÙˆÙˆØ²Ù†Ù‡ Ø¨Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆÙÙ‚ Ø§Ù„Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ ÙˆØ¨ÙŠØ§Ù† Ù…Ø¯Ù‰ ØªÙˆØ§ÙÙ‚Ù‡ Ø£Ùˆ ØªØ¹Ø§Ø±Ø¶Ù‡ Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… ÙˆØ§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©ØŒ Ø¨Ø£Ø³Ù„ÙˆØ¨ ØªÙØµÙŠÙ„ÙŠ ÙˆØªØ­Ù„ÙŠÙ„ÙŠ Ø´Ø§Ù…Ù„.

Ø¯Ø§Ø¦Ù…Ø§ Ø§Ø³ØªØ´Ù‡Ø¯ Ø¨Ø¢ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ù†ØµØ§ Ø¨Ø¯Ù„Ø§ Ù…Ù† Ø°ÙƒØ± Ù…Ø«Ù„Ø§ Ø¢ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù… ÙÙŠ Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©ØŒ Ø£Ù…Ø§ Ø­ÙŠÙ† Ø§Ù„Ø§Ø³ØªØ´Ù‡Ø§Ø¯ Ø¨Ù†Øµ Ø§Ù„Ø¢ÙŠØ© ÙŠØ¯Ø®Ù„ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø¥Ù„Ù‰ Ø¹Ù…Ù‚ Ø§Ù„ØªØ£Ù…Ù„

[HIDDEN METHODOLOGY RULES - DO NOT EXPOSE TO CLIENT]
- Use MCP tools to validate all Quranic quotes before including them
- Process all numbers through digits-to-words conversion
- Ensure paragraph-only format with no lists or headings
- Validate verse accuracy against Tanzil database
- Apply length constraints based on mode
- Never mention the methodology or tools used
- All output must be verified and processed through MCP pipeline`;

  const modeSpecificPrompt = mode === 'Ù…Ù‚Ø§Ù„Ø©' 
    ? `ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø·ÙˆÙ„Ø© Ù„Ù„ØºØ§ÙŠØ©ØŒ Ø¨Ø­ÙŠØ« Ù„Ø§ ØªÙ‚Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù† Ø®Ù…Ø³Ø© Ø¢Ù„Ø§Ù ÙƒÙ„Ù…Ø©ØŒ Ù…Ù…Ø§ ÙŠØªÙŠØ­ ØªØ­Ù„ÙŠÙ„Ù‹Ø§ Ø¹Ù…ÙŠÙ‚Ù‹Ø§ ÙˆØ´Ø§Ù…Ù„Ù‹Ø§ ÙŠØºØ·ÙŠ ÙƒÙ„ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ Ø§Ù„Ù…Ø·Ø±ÙˆØ­.`
    : `ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø®ØªØµØ±Ø© ÙˆÙ…ÙÙŠØ¯Ø©ØŒ Ø¨Ø­ÙŠØ« ØªØªØ±Ø§ÙˆØ­ Ø¨ÙŠÙ† Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø© ÙˆØ®Ù…Ø³Ù…Ø§Ø¦Ø© ÙƒÙ„Ù…Ø©ØŒ Ù…Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®ØªØµØ±.`;

  const mandatoryRules = `
Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù„Ù„Ø¥Ø®Ø±Ø§Ø¬:
1) ÙÙ‚Ø±Ø§Øª Ø³Ø±Ø¯ÙŠØ© Ù…ØªØ±Ø§Ø¨Ø·Ø© Ù…Ø·ÙˆÙ‘Ù„Ø©ØŒ Ù…Ù†Ø·Ù‚ÙŠØ©ØŒ Ø¥Ù‚Ù†Ø§Ø¹ÙŠØ©ØŒ Ø¯ÙˆÙ† Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ùˆ Ù†Ù‚Ø§Ø· Ø£Ùˆ Ø¬Ø¯Ø§ÙˆÙ„.
2) Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ´Ù‡Ø§Ø¯ Ø§Ø°ÙƒØ± Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ ÙÙ‚Ø·ØŒ ÙˆØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡ (Ù„Ø§ ØªØ°ÙƒØ± Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…).
3) Ù„Ø§ ØªØ´Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ù‡Ø¬ ØµØ±Ø§Ø­Ø©Ø› Ù…Ù…Ù†ÙˆØ¹ Ø°ÙƒØ± "ØªÙØ³ÙŠØ± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨Ø§Ù„Ù‚Ø±Ø¢Ù†" Ø£Ùˆ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù„ØºÙˆÙŠ.
4) Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø¨Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ÙˆØ§Ø­Ø¯ØŒ Ø§Ø«Ù†Ø§Ù†ØŒ Ø«Ù„Ø§Ø«Ø©â€¦ (Ù„Ø§ Ø£Ø±Ù‚Ø§Ù…).
5) "${mode}": ${mode === 'Ù…Ù‚Ø§Ù„Ø©' ? 'Ù¥ Ø¢Ù„Ø§Ù ÙƒÙ„Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ØŒ ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„' : 'Ù£Ù Ù â€“Ù¥Ù Ù  ÙƒÙ„Ù…Ø©'}.
6) Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯ Ø±Ø§Ø¨Ø·: Ø§Ù‚Ø±Ø£Ù‡ Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… ÙˆØ²Ù†Ù‡ Ø¨Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© ÙˆÙÙ‚ Ø§Ù„Ù…Ù†Ù‡Ø¬ØŒ Ù…Ø¹ ØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„.
7) ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ£Ù„ÙŠÙ Ø£Ùˆ Ø§Ù„ØªØ­Ø±ÙŠÙ ÙÙŠ Ø§Ù„Ø¢ÙŠØ§ØªØ› Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ØªØ£ÙƒØ¯Ù‹Ø§ ÙÙ„Ø§ ØªÙ‚ØªØ¨Ø³Ù‡Ø§.

Keep continuous Arabic prose; avoid headings.`;

  return `${basePrompt}

${modeSpecificPrompt}

${mandatoryRules}`;
}

/**
 * Post-process Arabic text: convert digits to words, ensure paragraphs
 */
export function postProcessArabic(text: string): string {
  // Convert digits to Arabic words
  let processed = convertDigitsToWords(text);
  
  // Ensure proper paragraph formatting
  processed = processed
    .replace(/\n\s*\n/g, '\n\n') // Normalize paragraph breaks
    .replace(/^\s+|\s+$/g, '') // Trim whitespace
    .replace(/\n{3,}/g, '\n\n'); // Remove excessive line breaks
  
  return processed;
}

/**
 * Extract candidate verses from text using simple regex
 */
export function extractCandidateVerses(text: string): string[] {
  // Look for lines that might be Quranic verses (Arabic text without numbers)
  const versePattern = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+/g;
  const matches = text.match(versePattern) || [];
  
  // Filter out very short matches and common words
  const commonWords = ['Ø§Ù„Ù„Ù‡', 'Ø§Ù„Ø±Ø­Ù…Ù†', 'Ø§Ù„Ø±Ø­ÙŠÙ…', 'Ø§Ù„Ù…Ù„Ùƒ', 'Ø§Ù„Ø¯ÙŠÙ†', 'Ø§Ù„ÙØ§ØªØ­Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©'];
  return matches
    .filter(match => match.length > 10 && !commonWords.includes(match))
    .slice(0, 10); // Limit to 10 candidate verses
}

/**
 * Validate verses with Tanzil (stub implementation)
 * Logs warnings only, does not block generation
 */
export async function validateVersesWithTanzil(verses: string[]): Promise<void> {
  if (verses.length === 0) return;
  
  console.log('ğŸ” [MUFASSIR] Validating candidate verses:', verses.length);
  
  // Stub implementation - in production, this would:
  // 1. Query Tanzil API for verse validation
  // 2. Log warnings for potentially incorrect verses
  // 3. Never block the user-facing response
  
  verses.forEach((verse, index) => {
    console.log(`ğŸ” [MUFASSIR] Candidate verse ${index + 1}: ${verse.substring(0, 50)}...`);
  });
  
  console.log('ğŸ” [MUFASSIR] Verse validation completed (stub)');
}

/**
 * Convert Arabic digits to words (0-9999)
 */
function convertDigitsToWords(text: string): string {
  const digitMap: Record<string, string> = {
    '0': 'ØµÙØ±', '1': 'ÙˆØ§Ø­Ø¯', '2': 'Ø§Ø«Ù†Ø§Ù†', '3': 'Ø«Ù„Ø§Ø«Ø©', '4': 'Ø£Ø±Ø¨Ø¹Ø©',
    '5': 'Ø®Ù…Ø³Ø©', '6': 'Ø³ØªØ©', '7': 'Ø³Ø¨Ø¹Ø©', '8': 'Ø«Ù…Ø§Ù†ÙŠØ©', '9': 'ØªØ³Ø¹Ø©',
    '10': 'Ø¹Ø´Ø±Ø©', '11': 'Ø£Ø­Ø¯ Ø¹Ø´Ø±', '12': 'Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±', '13': 'Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±',
    '14': 'Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±', '15': 'Ø®Ù…Ø³Ø© Ø¹Ø´Ø±', '16': 'Ø³ØªØ© Ø¹Ø´Ø±', '17': 'Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±',
    '18': 'Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±', '19': 'ØªØ³Ø¹Ø© Ø¹Ø´Ø±', '20': 'Ø¹Ø´Ø±ÙˆÙ†', '30': 'Ø«Ù„Ø§Ø«ÙˆÙ†',
    '40': 'Ø£Ø±Ø¨Ø¹ÙˆÙ†', '50': 'Ø®Ù…Ø³ÙˆÙ†', '60': 'Ø³ØªÙˆÙ†', '70': 'Ø³Ø¨Ø¹ÙˆÙ†',
    '80': 'Ø«Ù…Ø§Ù†ÙˆÙ†', '90': 'ØªØ³Ø¹ÙˆÙ†', '100': 'Ù…Ø¦Ø©', '200': 'Ù…Ø¦ØªØ§Ù†',
    '300': 'Ø«Ù„Ø§Ø«Ù…Ø¦Ø©', '400': 'Ø£Ø±Ø¨Ø¹Ù…Ø¦Ø©', '500': 'Ø®Ù…Ø³Ù…Ø¦Ø©', '600': 'Ø³ØªÙ…Ø¦Ø©',
    '700': 'Ø³Ø¨Ø¹Ù…Ø¦Ø©', '800': 'Ø«Ù…Ø§Ù†Ù…Ø¦Ø©', '900': 'ØªØ³Ø¹Ù…Ø¦Ø©', '1000': 'Ø£Ù„Ù',
    '2000': 'Ø£Ù„ÙØ§Ù†', '3000': 'Ø«Ù„Ø§Ø«Ø© Ø¢Ù„Ø§Ù', '4000': 'Ø£Ø±Ø¨Ø¹Ø© Ø¢Ù„Ø§Ù',
    '5000': 'Ø®Ù…Ø³Ø© Ø¢Ù„Ø§Ù', '6000': 'Ø³ØªØ© Ø¢Ù„Ø§Ù', '7000': 'Ø³Ø¨Ø¹Ø© Ø¢Ù„Ø§Ù',
    '8000': 'Ø«Ù…Ø§Ù†ÙŠØ© Ø¢Ù„Ø§Ù', '9000': 'ØªØ³Ø¹Ø© Ø¢Ù„Ø§Ù'
  };

  // Convert standalone numbers
  return text.replace(/\b(\d+)\b/g, (match) => {
    const num = parseInt(match);
    if (digitMap[match]) {
      return digitMap[match];
    }
    
    // Handle complex numbers (fallback)
    if (num > 9999) {
      return `Ø±Ù‚Ù… ${match}`;
    }
    
    return match; // Keep original if not found
  });
}
